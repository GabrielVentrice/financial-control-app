import{defineComponent as t,ref as e,computed as a,mergeProps as s,unref as n,useSSRContext as r}from"vue";import{ssrRenderAttrs as o,ssrInterpolate as i,ssrIncludeBooleanAttr as l,ssrRenderComponent as d,ssrRenderList as c,ssrRenderStyle as p,ssrRenderClass as m}from"vue/server-renderer";import{Bar as u}from"vue-chartjs";import{Chart as g,CategoryScale as v,LinearScale as x,BarElement as h,Title as f,Tooltip as y,Legend as b}from"chart.js";import{b as w}from"./server.mjs";import"../nitro/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../routes/renderer.mjs";import"vue-bundle-renderer/runtime";import"unhead/server";import"devalue";import"unhead/utils";import"unhead/plugins";import"vue-router";const $=t({__name:"installments",__ssrInlineRender:!0,setup(t){g.register(v,x,h,f,y,b);const{selectedPerson:r}=w(),{parseInstallment:$,isInstallmentTransaction:I}=(()=>{const parseInstallment=t=>{const e=t.match(/(\d{2})\/(\d{2})/);if(!e)return null;const a=parseInt(e[1]),s=parseInt(e[2]);return{description:t.substring(0,e.index).trim(),current:a,total:s}},isInstallmentTransaction=t=>{var e;const a=(null==(e=t.destination)?void 0:e.toLowerCase())||"";return a.includes("installments/financing")||a.includes("installments")&&a.includes("financing")},isFirstInstallment=t=>{const e=parseInstallment(t.description);return null!==e&&1===e.current},createInstallmentGroupKey=(t,e)=>(Math.abs(t.amount).toFixed(2),`${e.description.toLowerCase()}_${t.origin}`),generateMonthlyInstallments=(t,e)=>{const{total:a,description:s}=e,n=[],r=new Date(t.date);let o=new Date(r);o.setMonth(o.getMonth()+1),o.setDate(2);for(let e=1;e<=a;e++){let i;1===e?i=new Date(r):(i=new Date(o),i.setMonth(o.getMonth()+(e-2)));const l=i.toISOString().split("T")[0];n.push({...t,transactionId:`${t.transactionId}_${e}_${a}`,date:l,description:`${s} ${String(e).padStart(2,"0")}/${String(a).padStart(2,"0")}`,amount:t.amount})}return n};return{parseInstallment:parseInstallment,isInstallmentTransaction:isInstallmentTransaction,isFirstInstallment:isFirstInstallment,processInstallments:t=>{const e=[],a=new Map,s=new Set;console.log("🔍 [Installments] Total de transações recebidas:",t.length);const n=t.filter(t=>isInstallmentTransaction(t));console.log("🔍 [Installments] Transações de parcelas/financiamentos:",n.length);for(const s of t){if(!isInstallmentTransaction(s)){e.push(s);continue}console.log("📝 [Installments] Processando transação:",{id:s.transactionId,description:s.description,destination:s.destination});const t=parseInstallment(s.description);if(console.log("🔍 [Installments] Parse result:",{description:s.description,parsedInfo:t}),!t){console.log("❌ [Installments] Não conseguiu parsear, adicionando normalmente"),e.push(s);continue}const n=createInstallmentGroupKey(s,t);console.log("🔑 [Installments] Chave do grupo criada:",n),a.has(n)||(a.set(n,[]),console.log("➕ [Installments] Novo grupo criado:",n)),a.get(n).push(s),console.log("📋 [Installments] Transação adicionada ao grupo. Total no grupo:",a.get(n).length)}console.log("🔍 [Installments] Número de grupos identificados:",a.size),console.log("🔍 [Installments] Chaves dos grupos:",Array.from(a.keys()));const r=Object.fromEntries(Array.from(a.entries()).map(([t,e])=>[t,e.map(t=>({id:t.transactionId,date:t.date,description:t.description,amount:t.amount,origin:t.origin,destination:t.destination}))]));console.log("🔍 [Installments] Grupos de parcelas identificados:",JSON.stringify(r,null,2));for(const[t,n]of a)if(!s.has(t))try{const a=n.find(t=>isFirstInstallment(t));if(!a){e.push(...n),s.add(t);continue}const r=parseInstallment(a.description),o=generateMonthlyInstallments(a,r);e.push(...o),s.add(t)}catch(a){e.push(...n),s.add(t)}return e}}})();e([]);const D=e([]),M=e(!1),S=e(null),k=(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`})(),A=(()=>{const t=[],e=new Date;for(let a=-6;a<=6;a++){const s=new Date(e.getFullYear(),e.getMonth()+a,1),n=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`;t.push(n)}return t})(),P=a(()=>{let t=D.value.filter(t=>I(t));return"Ambos"!==r.value&&(t=t.filter(t=>t.person===r.value)),t}),T=a(()=>{const t=new Map;return P.value.forEach(e=>{const a=$(e.description);if(!a)return;const s=`${a.description}_${e.origin}_${a.total}`;t.has(s)||t.set(s,{key:s,description:a.description,origin:e.origin,amount:e.amount,total:a.total,paid:0,remaining:a.total,firstDate:e.date,lastDate:e.date,transactions:[]});const n=t.get(s);n.transactions.push(e),e.date<n.firstDate&&(n.firstDate=e.date),e.date>n.lastDate&&(n.lastDate=e.date);e.date.substring(0,7)<=k&&n.paid++}),t.forEach(t=>{t.remaining=t.total-t.paid}),Array.from(t.values())}),K=a(()=>T.value.filter(t=>t.remaining>0).sort((t,e)=>e.remaining-t.remaining)),C=a(()=>{const t=new Map;return A.forEach(e=>{t.set(e,{monthKey:e,count:0,total:0})}),P.value.forEach(e=>{const a=e.date.substring(0,7);if(t.has(a)){const s=t.get(a);s.count++,s.total+=e.amount}}),Array.from(t.values())}),_=a(()=>{const t=C.value.find(t=>t.monthKey===k);return(null==t?void 0:t.total)||0}),j=a(()=>C.value.reduce((t,e)=>t+e.total,0)/C.value.length),R=a(()=>({labels:C.value.map(t=>formatMonthYear(t.monthKey)),datasets:[{label:"Total de Parcelas",data:C.value.map(t=>t.total),backgroundColor:C.value.map(t=>t.monthKey===k?"rgba(37, 99, 235, 0.8)":t.monthKey<k?"rgba(156, 163, 175, 0.6)":"rgba(59, 130, 246, 0.5)"),borderColor:C.value.map(t=>t.monthKey===k?"rgb(29, 78, 216)":t.monthKey<k?"rgb(107, 114, 128)":"rgb(37, 99, 235)"),borderWidth:2}]})),E={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!1},tooltip:{callbacks:{label:t=>{const e=t.parsed.y;return`Total: ${formatCurrency(e)}`}}}},scales:{y:{beginAtZero:!0,ticks:{callback:t=>`R$ ${t.toLocaleString("pt-BR")}`}}}},formatCurrency=t=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t),formatDate=t=>{if(!t)return"-";try{return new Date(t).toLocaleDateString("pt-BR")}catch{return t}},formatMonthYear=t=>{const[e,a]=t.split("-");return new Date(parseInt(e),parseInt(a)-1).toLocaleDateString("pt-BR",{month:"short",year:"numeric"})};return(t,e,a,g)=>{e(`<div${o(s({class:"min-h-screen bg-gray-50"},g))}><div class="bg-white shadow"><div class="px-8 py-6"><h1 class="text-3xl font-bold text-gray-800">Análise de Parcelas</h1><p class="text-gray-600 mt-1">Visualize parcelas passadas e futuras por período</p></div></div><div class="px-8 py-4"><div class="bg-white rounded-lg shadow px-6 py-3"><div class="flex items-center justify-between gap-4 flex-wrap"><div class="flex items-center gap-2 text-sm text-gray-600"><span class="font-medium">Pessoa:</span><span class="px-3 py-1 bg-primary-100 text-primary-800 rounded-full font-medium">${i(n(r))}</span></div><button${l(M.value)?" disabled":""} class="px-4 py-1.5 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:bg-gray-400">${i(M.value?"Carregando...":"Atualizar")}</button></div></div></div>`),M.value?e('<div class="px-8 py-12 text-center"><div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary-500 border-t-transparent"></div><p class="mt-4 text-gray-600">Carregando dados...</p></div>'):S.value?e(`<div class="px-8 py-12"><div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center"><p class="text-red-800 font-medium">Erro ao carregar dados</p><p class="text-red-600 text-sm mt-2">${i(S.value)}</p></div></div>`):(e(`<div class="px-8 pb-8"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"><p class="text-gray-600 text-sm font-medium uppercase tracking-wide">Parcelas Ativas</p><p class="text-3xl font-bold text-gray-900 mt-2">${i(K.value.length)}</p><p class="text-xs text-gray-500 mt-1">Com parcelas futuras</p></div><div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"><p class="text-gray-600 text-sm font-medium uppercase tracking-wide">Total Mês Atual</p><p class="text-3xl font-bold text-gray-900 mt-2">${i(formatCurrency(_.value))}</p><p class="text-xs text-gray-500 mt-1">${i(formatMonthYear(n(k)))}</p></div><div class="bg-gradient-to-br from-primary-500 to-primary-700 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow"><p class="text-white text-sm font-medium uppercase tracking-wide opacity-90">Média Mensal</p><p class="text-4xl font-bold text-white mt-2">${i(formatCurrency(j.value))}</p><p class="text-xs text-white opacity-80 mt-1">Últimos 13 meses</p></div></div><div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4">Parcelas por Mês (6 meses atrás → 6 meses à frente)</h2><div class="h-96">`),e(d(n(u),{data:R.value,options:E},null,a)),e(`</div></div><div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4">Parcelas Ativas (${i(K.value.length)})</h2>`),0===K.value.length?e('<div class="text-center py-8 text-gray-500"><p>Nenhuma parcela ativa encontrada</p></div>'):(e('<div class="space-y-4">\x3c!--[--\x3e'),c(K.value,t=>{e(`<div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"><div class="flex justify-between items-start"><div class="flex-1"><h3 class="font-semibold text-gray-900 text-lg">${i(t.description)}</h3><div class="mt-2 flex flex-wrap gap-4 text-sm"><span class="text-gray-600"><span class="font-medium">Origem:</span> ${i(t.origin)}</span><span class="text-gray-600"><span class="font-medium">Valor:</span> ${i(formatCurrency(t.amount))}/mês </span></div></div><div class="text-right ml-4"><div class="text-2xl font-bold text-primary-600">${i(t.paid)}/${i(t.total)}</div><div class="text-xs text-gray-500 mt-1">${i(t.remaining)} restantes </div><div class="mt-2"><div class="w-32 bg-gray-200 rounded-full h-2"><div class="bg-primary-600 h-2 rounded-full transition-all" style="${p({width:t.paid/t.total*100+"%"})}"></div></div></div></div></div><div class="mt-3 grid grid-cols-2 gap-2 text-xs"><div class="bg-gray-50 rounded p-2"><span class="text-gray-600">Primeira parcela:</span><span class="font-medium text-gray-900 ml-1">${i(formatDate(t.firstDate))}</span></div><div class="bg-gray-50 rounded p-2"><span class="text-gray-600">Última parcela:</span><span class="font-medium text-gray-900 ml-1">${i(formatDate(t.lastDate))}</span></div></div></div>`)}),e("\x3c!--]--\x3e</div>")),e('</div><div class="bg-white rounded-lg shadow-md p-6"><h2 class="text-xl font-bold text-gray-800 mb-4">Detalhamento Mensal</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> Mês </th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> Qtd. Parcelas </th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> Total </th></tr></thead><tbody class="bg-white divide-y divide-gray-200">\x3c!--[--\x3e'),c(C.value,t=>{e(`<tr class="${m([{"bg-primary-50":t.monthKey===n(k)},"hover:bg-gray-50 transition-colors"])}"><td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center">`),t.monthKey===n(k)?e('<span class="mr-2 px-2 py-1 text-xs font-semibold rounded-full bg-primary-600 text-white"> Atual </span>'):e("\x3c!----\x3e"),e(`<span class="text-sm font-medium text-gray-900">${i(formatMonthYear(t.monthKey))}</span></div></td><td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${i(t.count)}</span></td><td class="px-6 py-4 whitespace-nowrap"><div class="text-lg font-bold text-primary-600">${i(formatCurrency(t.total))}</div></td></tr>`)}),e("\x3c!--]--\x3e</tbody></table></div></div></div>")),e("</div>")}}}),I=$.setup;$.setup=(t,e)=>{const a=r();return(a.modules||(a.modules=new Set)).add("pages/installments.vue"),I?I(t,e):void 0};export{$ as default};
